version: "2.4"
services:
  mysql:
    image: percona:latest
    restart: always
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
    volumes:
      - spaceage_mysql:/var/lib/mysql
  php:
    #image: php:fpm-alpine
    build: php
    restart: always
    user: 1000:1000
    links:
      - mysql:mysql
    volumes:
      - spaceage_wwwroot:/var/www
  tts:
    image: ghcr.io/spaceagemp/tts/tts:latest
    init: yes
    restart: always
    environment:
      AWS_REGION: ${TTS_AWS_REGION}
      AWS_ACCESS_KEY_ID: ${TTS_AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${TTS_AWS_SECRET_ACCESS_KEY}
  api:
    image: ghcr.io/spaceagemp/space_age_api/api
    restart: always
    init: yes
    environment:
      - SENTRY_DSN_SRCDS
      - SENTRY_DSN_API
      - SECRET_KEY_BASE
      - DATABASE_URL
      - MIX_ENV=prod
  nginx:
    #image: nginx:alpine
    build: nginx
    restart: always
    volumes:
      - spaceage_wwwroot:/var/www
      - spaceage_ssl:/etc/nginx/ssl
    links:
      - php:php
      - tts:tts
      - api:api
    ports:
      - 443:443

volumes:
  spaceage_wwwroot:
    external: true
  spaceage_mysql:
    external: true
  spaceage_ssl:
    external: true
  spaceage_tts_awscreds:
    external: true
